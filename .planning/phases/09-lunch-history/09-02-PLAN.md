---
phase: 09-lunch-history
plan: "02"
type: execute
wave: 2
depends_on:
  - "09-01"
files_modified:
  - src/app/layout.tsx
  - src/components/layout/nav-links.tsx
  - src/app/page.tsx
  - src/app/history/page.tsx
autonomous: false
requirements:
  - HIST-01
  - HIST-02
  - HIST-03
  - HIST-04

must_haves:
  truths:
    - "Clicking '確認本週計畫' on the picker page saves 5 history entries to localStorage"
    - "The recommendation algorithm uses non-recently-visited restaurants as the primary pool"
    - "A /history page shows all past picks with date and restaurant name"
    - "Users can remove individual entries or clear all history from /history"
    - "The lookback days setting on /history page persists via localStorage"
    - "A '午餐歷史' nav link navigates to /history"
    - "History persists across page reloads (localStorage-backed)"
  artifacts:
    - path: "src/app/layout.tsx"
      provides: "HistoryProvider wrapping children alongside RestaurantProvider"
      contains: "HistoryProvider"
    - path: "src/components/layout/nav-links.tsx"
      provides: "Nav link to /history"
      contains: "午餐歷史"
    - path: "src/app/page.tsx"
      provides: "Confirm plan button wiring to addEntries, history-aware pool split"
      contains: "確認本週計畫"
    - path: "src/app/history/page.tsx"
      provides: "History page with past picks list, remove/clear controls, lookback setting"
      contains: "午餐歷史"
  key_links:
    - from: "src/app/page.tsx"
      to: "src/lib/history-context.tsx"
      via: "useHistory() hook for addEntries and entries"
      pattern: "useHistory"
    - from: "src/app/page.tsx"
      to: "src/lib/history.ts"
      via: "getRecentlyVisitedIds + splitPoolByHistory for pool filtering"
      pattern: "splitPoolByHistory"
    - from: "src/app/history/page.tsx"
      to: "src/lib/history-context.tsx"
      via: "useHistory() hook for entries, removeEntry, clearHistory, setLookbackDays"
      pattern: "useHistory"
    - from: "src/app/layout.tsx"
      to: "src/lib/history-context.tsx"
      via: "HistoryProvider wrapping children"
      pattern: "HistoryProvider"
---

<objective>
Wire the history system into the app: provider in layout, confirm button on picker page, pool-split deprioritization, history page with management UI, and nav link.

Purpose: Make history visible and actionable — users can confirm plans, browse past picks, manage history, and get fresher recommendations automatically.
Output: Fully functional history feature accessible from the nav bar.
</objective>

<execution_context>
@/Users/diamond.hung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/app/layout.tsx
@src/components/layout/nav-links.tsx
@src/app/page.tsx
@src/app/weekend/page.tsx
@src/lib/history-context.tsx
@src/lib/history.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire HistoryProvider into layout and add /history nav link</name>
  <files>
    src/app/layout.tsx
    src/components/layout/nav-links.tsx
    src/app/history/page.tsx
  </files>
  <action>
**src/app/layout.tsx** — wrap `RestaurantProvider` with `HistoryProvider`. Import `HistoryProvider` from `@/lib/history-context`. The nesting should be:

```tsx
<ThemeProvider ...>
  <Header />
  <HistoryProvider>
    <RestaurantProvider>
      <main className="min-h-screen">{children}</main>
    </RestaurantProvider>
  </HistoryProvider>
</ThemeProvider>
```

HistoryProvider outside RestaurantProvider because the history page and picker page both need history, and HistoryProvider has no dependency on RestaurantProvider. Layout.tsx remains a Server Component — importing a Client Component provider is valid in App Router (same existing pattern as RestaurantProvider).

**src/components/layout/nav-links.tsx** — add `/history` to `NAV_ITEMS` array:
```ts
const NAV_ITEMS = [
  { href: '/', label: '今日推薦' },
  { href: '/restaurants', label: '餐廳管理' },
  { href: '/weekend', label: '假日推薦' },
  { href: '/history', label: '午餐歷史' },
] as const
```

**src/app/history/page.tsx** — create the history page as a Client Component:
- `'use client'` directive
- Import `useHistory` from `@/lib/history-context`
- Hydration guard: return skeleton `<h1>午餐歷史</h1>` when `!isHydrated` (same pattern as weekend/page.tsx)
- When `entries.length === 0`: show "尚無歷史記錄" message
- When entries exist: render a list/table with columns: 日期, 餐廳, 操作
  - Each row shows `entry.date` and `entry.restaurantName`
  - Each row has a "移除" button that calls `removeEntry(entry.id)`
- Lookback days setting section: `<Label>最近 N 個工作天內不重複推薦</Label>` with a number `<Input>` (min=1, max=30, step=1) bound to `lookbackDays`, onChange calls `setLookbackDays(valueAsNumber)` — clamp to 1 if NaN
- "清除全部歷史" button (variant="destructive" or variant="outline") that calls `clearHistory()`, show only when entries.length > 0
- Group entries by date (most recent first) for readability, or simply list all entries sorted by date descending
- Use shadcn/ui `Button`, `Input`, `Label` — import from `@/components/ui/...`
- Page heading: `<h1 className="text-2xl font-semibold mb-6">午餐歷史</h1>`
- Entries container: simple list with `divide-y` border styling, no shadcn Table needed (keep it simple)
  </action>
  <verify>
Run `npx tsc --noEmit` — zero errors. Start dev server (`npm run dev`) and:
1. Confirm '午餐歷史' appears in nav bar and navigates to /history
2. /history page renders without error (empty state or entries list)
  </verify>
  <done>HistoryProvider wraps children in layout.tsx. Nav bar shows '午餐歷史' link. /history page renders correctly in both empty and populated states.</done>
</task>

<task type="auto">
  <name>Task 2: Wire confirm button and history-aware pool split into picker page</name>
  <files>src/app/page.tsx</files>
  <action>
Modify `src/app/page.tsx` to:

**1. Import history hooks and functions:**
```ts
import { useHistory } from '@/lib/history-context'
import { getRecentlyVisitedIds, splitPoolByHistory, type LunchHistoryEntry } from '@/lib/history'
```

**2. Use history in component:**
```ts
const { entries, addEntries, lookbackDays, isHydrated: historyHydrated } = useHistory()
```

Wait for both hydration guards before rendering full UI: `const ready = isHydrated && historyHydrated`

**3. History-aware pool computation** (compute before generate/reroll calls):
```ts
const recentIds = getRecentlyVisitedIds(entries, lookbackDays)
const { primary, fallback } = splitPoolByHistory(restaurants, recentIds)
const effectivePool = primary.length > 0 ? primary : fallback
```

Use `effectivePool` in both `handleGenerate` (replacing `restaurants`) and `handleReroll` (replacing `restaurants`). This means:
- `generateWeeklyPlan(effectivePool, budget)` — not `generateWeeklyPlan(restaurants, budget)`
- `rerollSlot(plan, index, effectivePool)` — not `rerollSlot(plan, index, restaurants)`

**4. Add '確認本週計畫' button** — shown only when `plan !== null`:

```tsx
<Button variant="outline" onClick={handleConfirmPlan}>
  確認本週計畫
</Button>
```

Place it next to the '產生本週午餐計畫' button row, or below the 5-day grid — below the grid is clearer (user reviews first, then confirms). Add a small helper text: "確認後，本週餐廳將加入歷史，未來推薦將避免重複".

**handleConfirmPlan implementation:**
```ts
function handleConfirmPlan() {
  if (!plan) return
  const today = new Date().toLocaleDateString('sv') // 'sv' locale gives YYYY-MM-DD in local time
  const newEntries: LunchHistoryEntry[] = plan.days.map((r) => ({
    id: crypto.randomUUID(),
    date: today,
    restaurantId: r.id,
    restaurantName: r.name,
  }))
  addEntries(newEntries)
}
```

**5. Guard check:** Keep existing guards — `if (restaurants.length === 0 || isNaN(budget)) return` in handleGenerate. Also guard handleConfirmPlan against null plan.

**Do NOT** remove the existing local `history`/`selectedIndex` session state (that tracks the plan history within the current session for switching between previously generated plans). That is separate from the persistent lunch history. Rename the existing local variable if needed to avoid shadowing — e.g., rename local `history` to `planHistory` and `setHistory` to `setPlanHistory`.
  </action>
  <verify>
Run `npx tsc --noEmit` — zero errors. Manual test:
1. Generate a plan — '確認本週計畫' button appears below the grid
2. Click '確認本週計畫' — navigate to /history — 5 entries appear with today's date
3. Reload page — entries still appear (localStorage persisted)
4. Reroll a slot — it uses the effective pool (recently confirmed restaurants deprioritized)
  </verify>
  <done>
Picker page compiles cleanly. '確認本週計畫' saves 5 LunchHistoryEntry records to history. Pool split uses getRecentlyVisitedIds + splitPoolByHistory. Both generate and reroll use effectivePool. Existing session plan history (planHistory state) still works.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Full history feature: HistoryProvider in layout, /history page with past picks + remove/clear + lookback config, '確認本週計畫' button on picker, history-aware pool deprioritization, nav link '午餐歷史'.
  </what-built>
  <how-to-verify>
    With `npm run dev` running:

    1. Go to http://localhost:3000 — confirm '午餐歷史' appears in nav bar
    2. Generate a weekly plan → click '確認本週計畫' → verify no error
    3. Click '午餐歷史' in nav → confirm the /history page shows 5 entries with today's date and restaurant names
    4. On /history page, change lookback days to 1 → navigate back to picker → regenerate plan → some previously confirmed restaurants should still be available (lookback=1 means only today is recent, pool-split puts them in secondary)
    5. On /history, click '移除' on one entry → it disappears immediately
    6. Reload the page → /history still shows the remaining entries (localStorage persisted)
    7. Click '清除全部歷史' → all entries removed, "尚無歷史記錄" shows
    8. Reload → /history shows empty state (cleared history persisted)
    9. Confirm dark mode still works (ThemeToggle in header, both light/dark render /history correctly)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npm run build` passes (no build errors)
- /history page accessible from nav bar
- Confirm button creates 5 entries in localStorage under 'what-lunch-history'
- History entries visible on /history page with date + restaurant name
- Remove and clear operations work and persist
- Lookback days setting persists across reload
- Pool deprioritization active: generate plan after confirming — same restaurants less likely to appear
- Dark mode renders /history page correctly
</verification>

<success_criteria>
All 5 phase success criteria met:
1. Confirming plan saves picks to localStorage history
2. /history page shows past picks with dates
3. Algorithm deprioritizes recently visited (pool split by history)
4. Users can clear or remove individual history entries
5. History persists across page reloads
</success_criteria>

<output>
After completion, create `.planning/phases/09-lunch-history/09-02-SUMMARY.md`
</output>
