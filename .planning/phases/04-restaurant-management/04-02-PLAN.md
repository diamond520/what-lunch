---
phase: 04-restaurant-management
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/restaurants/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can see all 19 default restaurants in a table with name, cuisine type, price, and distance columns"
    - "User can add a new restaurant via the form and it appears in the table immediately"
    - "Submitting the form with non-numeric price or distance shows a visible validation error"
    - "User can remove any restaurant by clicking the trash icon and it disappears immediately"
    - "Each restaurant row shows a color-coded cuisine type tag (e.g., green for Chinese, orange for Japanese)"
    - "Table shows an empty state message when all restaurants are removed"
  artifacts:
    - path: "src/app/restaurants/page.tsx"
      provides: "Full restaurant management page with table, form, validation, remove, cuisine tags"
      min_lines: 120
  key_links:
    - from: "src/app/restaurants/page.tsx"
      to: "src/lib/restaurant-context.tsx"
      via: "useRestaurants() hook for restaurants array, addRestaurant, removeRestaurant"
      pattern: "useRestaurants\\(\\)"
    - from: "src/app/restaurants/page.tsx"
      to: "src/lib/types.ts"
      via: "imports CUISINE_META for tag colors/labels and CuisineType for state typing"
      pattern: "CUISINE_META"
    - from: "src/app/restaurants/page.tsx"
      to: "src/components/ui/table.tsx"
      via: "imports Table, TableHeader, TableBody, TableHead, TableRow, TableCell"
      pattern: "import.*Table.*from.*components/ui/table"
    - from: "src/app/restaurants/page.tsx"
      to: "src/components/ui/select.tsx"
      via: "imports Select components for cuisine type dropdown"
      pattern: "import.*Select.*from.*components/ui/select"
---

<objective>
Build the complete restaurant management page with table display, add form with validation, remove functionality, and color-coded cuisine tags.

Purpose: This is the primary user-facing feature of Phase 4. Users need to view their restaurant list, add new restaurants with validated input, and remove restaurants they no longer want. Cuisine type tags provide visual grouping. This page replaces the placeholder created in Phase 2.

Output: A fully functional /restaurants page as a single Client Component.
</objective>

<execution_context>
@/Users/diamond.hung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-restaurant-management/04-RESEARCH.md
@.planning/phases/04-restaurant-management/04-01-SUMMARY.md

@src/lib/types.ts
@src/lib/restaurants.ts
@src/lib/restaurant-context.tsx
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build restaurant table with cuisine tags and remove buttons</name>
  <files>src/app/restaurants/page.tsx</files>
  <action>
    Replace the placeholder content in `src/app/restaurants/page.tsx` with a full Client Component. Add `'use client'` as the first line.

    **Imports:**
    - `useState` from `react`
    - `Trash2` from `lucide-react`
    - `useRestaurants` from `@/lib/restaurant-context`
    - `CUISINE_META` from `@/lib/types` and `CuisineType` type
    - shadcn components: `Table`, `TableBody`, `TableCell`, `TableHead`, `TableHeader`, `TableRow` from `@/components/ui/table`
    - `Button` from `@/components/ui/button`
    - `Input` from `@/components/ui/input`
    - `Label` from `@/components/ui/label`
    - `Select`, `SelectContent`, `SelectItem`, `SelectTrigger`, `SelectValue` from `@/components/ui/select`

    **Page structure:**
    - Container div with `className="container mx-auto px-4 py-8"`
    - `<h1>` with text "餐廳管理" and `className="text-2xl font-semibold mb-6"`
    - Restaurant table (described below)
    - Add restaurant form (described below)

    **Restaurant table:**
    - Use shadcn `Table` with 5 columns: 名稱, 料理類型, 價格 (NT$), 距離 (m), and an empty header for the action column
    - Map `restaurants` array (from `useRestaurants()`) to `TableRow` elements with `key={r.id}`
    - Each row renders:
      - `r.name` in first cell
      - A `CuisineTag` inline element in second cell: a `<span>` with `className="inline-flex items-center rounded-md px-2 py-0.5 text-xs font-medium text-white"` and `style={{ backgroundColor: CUISINE_META[r.type].color }}` displaying `CUISINE_META[r.type].label`. Do NOT use the shadcn Badge component for this — inline style is required because CUISINE_META colors are runtime hex values that Tailwind cannot process.
      - `r.price` in third cell
      - `r.distance` in fourth cell
      - A `Button` with `variant="ghost"` `size="icon"` containing `<Trash2 className="h-4 w-4" />` in fifth cell, `onClick={() => removeRestaurant(r.id)}`. Do NOT use `variant="destructive"` — ghost icon buttons are the correct pattern for inline table actions.
    - **Empty state:** When `restaurants.length === 0`, render a single `TableRow` with a `TableCell` that has `colSpan={5}` and `className="text-center text-muted-foreground py-8"` showing "尚無餐廳資料" (No restaurant data).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - The file contains `'use client'` as the first line
    - The file imports from `@/lib/restaurant-context` and `@/lib/types`
    - The file uses `CUISINE_META[r.type].color` with inline style (not Tailwind class)
    - The file uses `variant="ghost"` for the remove button (not "destructive")
  </verify>
  <done>
    Restaurant table renders all restaurants with name, cuisine tag (color-coded), price, distance, and trash icon remove button. Empty state shows a message. No TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build add restaurant form with numeric validation</name>
  <files>src/app/restaurants/page.tsx</files>
  <action>
    Add the "Add Restaurant" form below the table in the same `RestaurantsPage` component. This is NOT a separate file — it goes in the same page component alongside the table.

    **Form state (all inside the RestaurantsPage component):**
    - `name: string` — initialized to `''`
    - `cuisineType: CuisineType` — initialized to `'chi'`
    - `price: number | null` — initialized to `null`
    - `distance: number | null` — initialized to `null`
    - `priceError: string` — initialized to `''`
    - `distanceError: string` — initialized to `''`

    **Form layout:**
    - Wrap in a `<form onSubmit={handleSubmit}>` element
    - Add a heading: `<h2 className="text-lg font-semibold mt-8 mb-4">新增餐廳</h2>`
    - Use a grid layout for the form fields: `className="grid grid-cols-1 sm:grid-cols-2 gap-4"`
    - Four fields, each with a `<Label>` and corresponding input:

    1. **Name field:** `<Label htmlFor="name">名稱</Label>` + shadcn `<Input id="name" value={name} onChange={e => setName(e.target.value)} placeholder="餐廳名稱" required />`

    2. **Cuisine type field:** `<Label htmlFor="cuisine">料理類型</Label>` + shadcn `<Select value={cuisineType} onValueChange={v => setCuisineType(v as CuisineType)}>` with `SelectTrigger`, `SelectValue` (placeholder="選擇料理類型"), and `SelectContent` mapping `Object.entries(CUISINE_META)` to `SelectItem` elements. Cast the entries: `(Object.entries(CUISINE_META) as [CuisineType, { label: string; color: string }][])`. Each `SelectItem` has `key={key}` and `value={key}`, displaying `meta.label`.

    3. **Price field:** `<Label htmlFor="price">價格 (NT$)</Label>` + shadcn `<Input id="price" type="number" step="1" min="0" placeholder="例: 100" onChange={handlePriceChange} value={price ?? ''} />`. Show `priceError` below the input in a `<p className="text-sm text-destructive">{priceError}</p>` when non-empty.

    4. **Distance field:** `<Label htmlFor="distance">距離 (m)</Label>` + shadcn `<Input id="distance" type="number" step="1" min="0" placeholder="例: 150" onChange={handleDistanceChange} value={distance ?? ''} />`. Show `distanceError` below the input in a `<p className="text-sm text-destructive">{distanceError}</p>` when non-empty.

    **Numeric input handlers:**
    - `handlePriceChange(e)`: Read `e.target.valueAsNumber`. If `isNaN(val)` and `e.target.value !== ''`, set `priceError` to '價格必須是數字' and `price` to `null`. Otherwise clear error and set `price` to `isNaN(val) ? null : val`.
    - `handleDistanceChange(e)`: Same pattern with '距離必須是數字' error message.

    **Submit handler (`handleSubmit`):**
    1. `e.preventDefault()`
    2. Validate all fields:
       - If `!name.trim()` — do not submit (the `required` attribute on the input provides browser-native validation, but guard in JS too)
       - If `price === null || isNaN(price)` — set `priceError` to '請輸入有效的價格', set `valid = false`
       - If `distance === null || isNaN(distance)` — set `distanceError` to '請輸入有效的距離', set `valid = false`
       - Clear error strings for valid fields
    3. If `!valid`, return early (do NOT call addRestaurant)
    4. Call `addRestaurant({ id: crypto.randomUUID(), name: name.trim(), type: cuisineType, price: price!, distance: distance! })`
    5. Reset all form state: `setName('')`, `setCuisineType('chi')`, `setPrice(null)`, `setDistance(null)`, `setPriceError('')`, `setDistanceError('')`

    **Submit button:**
    - Below the grid: `<Button type="submit" className="mt-4">新增</Button>`

    **Important anti-patterns to avoid:**
    - Do NOT use `parseInt()` or `Number()` for numeric conversion — use `valueAsNumber`
    - Do NOT use `e.target.value` for price/distance — always `e.target.valueAsNumber`
    - Do NOT forget to clear error messages on valid submission
    - Do NOT use `Date.now()` or custom ID generation — use `crypto.randomUUID()`
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` completes without errors
    - The file uses `valueAsNumber` (not parseInt/parseFloat/Number)
    - The file uses `crypto.randomUUID()` for ID generation
    - The file contains error display elements with `text-destructive` class
    - The file resets form state after successful submission
  </verify>
  <done>
    Add restaurant form renders with name, cuisine type dropdown, price, and distance fields. Submitting with valid data adds a restaurant to the table immediately. Submitting with non-numeric price or distance shows Chinese-language validation errors. Form resets after successful add. Build passes.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with zero errors
- Navigate to /restaurants: table shows 19 default restaurants with columns (name, cuisine tag, price, distance, trash icon)
- Each cuisine tag is color-coded (green for chi, orange for jp, red for kr, gray for tai, teal for west)
- Click trash icon on any row: restaurant disappears immediately
- Fill in the add form with valid data and submit: new restaurant appears at bottom of table
- Submit form with empty price field: validation error "請輸入有效的價格" appears
- Submit form with non-numeric distance: validation error "請輸入有效的距離" appears
- Remove all restaurants: empty state message "尚無餐廳資料" appears
- Navigate away and back to /restaurants: state persists (context is in layout)
</verification>

<success_criteria>
- All 5 phase success criteria met:
  1. Table displays all restaurants with name, cuisine type, price, distance columns
  2. Add form works — new entry appears immediately in table
  3. Non-numeric price/distance rejected with visible validation error
  4. Remove button removes restaurant immediately
  5. Cuisine type tags are color-coded per CUISINE_META
- `npm run build` passes
- Existing 22 tests still pass (`npm test`)
</success_criteria>

<output>
After completion, create `.planning/phases/04-restaurant-management/04-02-SUMMARY.md`
</output>
