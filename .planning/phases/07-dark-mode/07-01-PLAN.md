---
phase: 07-dark-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/theme-provider.tsx
  - src/components/layout/theme-toggle.tsx
  - src/components/layout/header.tsx
  - src/app/layout.tsx
autonomous: false

must_haves:
  truths:
    - "A theme toggle button is visible in the header/nav area"
    - "Clicking the toggle switches all pages between light and dark color schemes"
    - "The app respects the OS-level color scheme preference on first load"
    - "The chosen theme persists across page reloads via localStorage"
    - "All existing UI components (tables, cards, forms, badges) render correctly in both themes"
  artifacts:
    - path: "src/components/theme-provider.tsx"
      provides: "Client wrapper for NextThemesProvider"
      contains: "use client"
    - path: "src/components/layout/theme-toggle.tsx"
      provides: "Sun/Moon toggle button with mounted guard"
      contains: "useTheme"
    - path: "src/components/layout/header.tsx"
      provides: "Header with ThemeToggle positioned at right end"
      contains: "ThemeToggle"
    - path: "src/app/layout.tsx"
      provides: "Root layout with ThemeProvider wrapping all content"
      contains: "ThemeProvider"
  key_links:
    - from: "src/app/layout.tsx"
      to: "src/components/theme-provider.tsx"
      via: "import and JSX wrapper"
      pattern: "import.*ThemeProvider.*theme-provider"
    - from: "src/components/layout/theme-toggle.tsx"
      to: "next-themes"
      via: "useTheme hook"
      pattern: "useTheme.*from.*next-themes"
    - from: "src/components/layout/header.tsx"
      to: "src/components/layout/theme-toggle.tsx"
      via: "import and JSX render"
      pattern: "import.*ThemeToggle.*theme-toggle"
    - from: "src/app/layout.tsx"
      to: "html element"
      via: "suppressHydrationWarning prop"
      pattern: "suppressHydrationWarning"
---

<objective>
Add dark mode support with a theme toggle in the header. Users can switch between light/dark themes; the app respects system preference on first load and persists the choice in localStorage.

Purpose: Visual comfort — users can switch to dark mode for low-light environments. This leverages the existing shadcn/ui dark CSS variables already defined in globals.css.
Output: ThemeProvider wrapper, ThemeToggle button in header, layout.tsx wired with theme support. Zero CSS changes needed — existing `.dark {}` variables handle everything.
</objective>

<execution_context>
@/Users/diamond.hung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-dark-mode/07-RESEARCH.md

@src/app/layout.tsx
@src/app/globals.css
@src/components/layout/header.tsx
@src/components/layout/nav-links.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install next-themes and create ThemeProvider + ThemeToggle components</name>
  <files>
    src/components/theme-provider.tsx
    src/components/layout/theme-toggle.tsx
  </files>
  <action>
1. Install next-themes:
   ```bash
   npm install next-themes
   ```

2. Create `src/components/theme-provider.tsx` — a thin `"use client"` wrapper around `NextThemesProvider`. This is required because `layout.tsx` is a Server Component and cannot directly use Client-only providers.
   ```typescript
   "use client"

   import * as React from "react"
   import { ThemeProvider as NextThemesProvider } from "next-themes"

   export function ThemeProvider({
     children,
     ...props
   }: React.ComponentProps<typeof NextThemesProvider>) {
     return <NextThemesProvider {...props}>{children}</NextThemesProvider>
   }
   ```

3. Create `src/components/layout/theme-toggle.tsx` — a Client Component that renders a Sun/Moon toggle button. MUST include a `mounted` state guard to prevent hydration mismatch (because `useTheme()` returns `undefined` on the server). Use `lucide-react` icons (already installed). Use shadcn `Button` component with `variant="ghost" size="icon"`.
   ```typescript
   "use client"

   import * as React from "react"
   import { Moon, Sun } from "lucide-react"
   import { useTheme } from "next-themes"
   import { Button } from "@/components/ui/button"

   export function ThemeToggle() {
     const { setTheme, theme } = useTheme()
     const [mounted, setMounted] = React.useState(false)

     React.useEffect(() => setMounted(true), [])

     if (!mounted) {
       return (
         <Button variant="ghost" size="icon" disabled>
           <Sun className="h-[1.2rem] w-[1.2rem]" />
           <span className="sr-only">Toggle theme</span>
         </Button>
       )
     }

     return (
       <Button
         variant="ghost"
         size="icon"
         onClick={() => setTheme(theme === "light" ? "dark" : "light")}
       >
         <Sun className="h-[1.2rem] w-[1.2rem] dark:hidden" />
         <Moon className="hidden h-[1.2rem] w-[1.2rem] dark:block" />
         <span className="sr-only">Toggle theme</span>
       </Button>
     )
   }
   ```

Key points:
- Do NOT use `resolvedTheme` — the simple `theme === "light" ? "dark" : "light"` toggle covers light/dark/system correctly because when `theme` is `"system"`, clicking switches to `"dark"` or `"light"` explicitly.
- The `dark:hidden` / `dark:block` classes handle icon visibility via CSS (no JS flicker).
- The placeholder returned before mount matches the layout dimensions to prevent shift.
  </action>
  <verify>
    - `npm ls next-themes` shows next-themes installed
    - `npx tsc --noEmit` passes with no type errors
    - Both new files exist and contain "use client" directive
  </verify>
  <done>
    - `src/components/theme-provider.tsx` exports `ThemeProvider` component
    - `src/components/layout/theme-toggle.tsx` exports `ThemeToggle` component with mounted guard
    - next-themes is in package.json dependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire ThemeProvider into layout.tsx and ThemeToggle into header.tsx</name>
  <files>
    src/app/layout.tsx
    src/components/layout/header.tsx
  </files>
  <action>
1. Modify `src/app/layout.tsx`:
   - Add `import { ThemeProvider } from "@/components/theme-provider"` to imports
   - Add `suppressHydrationWarning` prop to the `<html>` element (required because next-themes modifies the class attribute client-side, causing a server/client mismatch without this prop)
   - Wrap the body CONTENTS (both `<Header />` and `<RestaurantProvider>` + `<main>`) with `<ThemeProvider>`. ThemeProvider MUST wrap Header too — ThemeToggle inside Header calls `useTheme()` which requires the provider above it in the tree.
   - ThemeProvider props: `attribute="class"` (matches existing `@custom-variant dark (&:is(.dark *));` in globals.css), `defaultTheme="system"` (respect OS preference), `enableSystem` (listen for system preference changes), `disableTransitionOnChange` (prevent jarring CSS transition cascade on theme switch).

   The resulting layout structure should be:
   ```
   <html lang="zh-TW" suppressHydrationWarning>
     <body>
       <ThemeProvider attribute="class" defaultTheme="system" enableSystem disableTransitionOnChange>
         <Header />
         <RestaurantProvider>
           <main>{children}</main>
         </RestaurantProvider>
       </ThemeProvider>
     </body>
   </html>
   ```

   Do NOT change any other attributes on `<html>` or `<body>`. Do NOT modify globals.css — the existing `.dark {}` block and `@custom-variant dark` directive are already correct.

2. Modify `src/components/layout/header.tsx`:
   - Add `import { ThemeToggle } from './theme-toggle'`
   - Add `<div className="ml-auto"><ThemeToggle /></div>` after `<NavLinks />` inside the flex container. The `ml-auto` pushes the toggle to the right end of the flex row.

   The resulting header structure should be:
   ```
   <header>
     <div className="container mx-auto flex h-14 max-w-screen-2xl items-center px-4">
       <span>What Lunch?</span>
       <NavLinks />
       <div className="ml-auto">
         <ThemeToggle />
       </div>
     </div>
   </header>
   ```
  </action>
  <verify>
    - `npm run build` completes with no errors
    - `npm run dev` — app loads without console errors or hydration warnings
    - Theme toggle button is visible in the header at the right end
  </verify>
  <done>
    - layout.tsx wraps all content in ThemeProvider with attribute="class", defaultTheme="system", enableSystem, disableTransitionOnChange
    - html element has suppressHydrationWarning
    - header.tsx renders ThemeToggle at the right end of the nav bar
    - `npm run build` passes cleanly
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete dark mode support: ThemeProvider, ThemeToggle button, layout and header integration. The app should toggle between light and dark themes with system preference detection and localStorage persistence.</what-built>
  <how-to-verify>
    1. Run `npm run dev` and open http://localhost:3000
    2. Look for a Sun/Moon icon button at the RIGHT end of the header nav bar
    3. Click the toggle — the entire app should switch between light and dark color schemes
    4. Verify these pages all look correct in dark mode:
       - Home page (/) — weekly plan cards, budget input
       - Restaurants page (/restaurants) — table, add form, cuisine badges
       - Weekend page (/weekend) — random pick card, re-roll button
    5. Set your OS to dark mode (System Settings > Appearance > Dark) — reload the page, the app should start in dark mode
    6. Switch theme to Light via toggle, reload the page — it should stay Light (localStorage persistence)
    7. Check browser console for any hydration warnings
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual issues (contrast problems, unreadable text, broken layouts)</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` — no TypeScript or build errors
2. `npm run lint` — no new lint warnings
3. `npm test` — all existing tests still pass (dark mode has no logic to unit test)
4. Theme toggle visible in header, functional light/dark switching
5. System preference respected on first load
6. Theme persists in localStorage across reloads
7. No React hydration warnings in console
</verification>

<success_criteria>
- Theme toggle button exists in header nav area
- Clicking toggle switches all pages between light and dark
- App respects OS color scheme preference on first load
- Chosen theme persists across page reloads via localStorage
- All existing UI (tables, cards, forms, badges) renders correctly in both themes
- Zero CSS changes — leverages existing globals.css .dark {} variables
- npm run build passes, npm test passes, no console errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-dark-mode/07-01-SUMMARY.md`
</output>
