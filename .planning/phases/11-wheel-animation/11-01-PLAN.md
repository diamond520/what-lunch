---
phase: 11-wheel-animation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/use-slot-animation.ts
  - src/app/weekend/page.tsx
  - __tests__/use-slot-animation.test.ts
  - __tests__/weekend-page.test.tsx
autonomous: true
requirements: []

must_haves:
  truths:
    - "Clicking '隨機推薦' on the weekend page starts a cycling name animation (not instant result)"
    - "The animating card shows restaurant names cycling rapidly for ~2.5 seconds before settling"
    - "User can press Space/Enter/Escape or click the animating card to skip and see the result immediately"
    - "After animation settles, the full result card (name, cuisine, price, distance, rating) is revealed with a fade-in"
    - "Clicking '換一間' after a result triggers a new animation cycle for the new pick"
    - "The '隨機推薦' and '換一間' buttons are disabled while animation is running"
  artifacts:
    - path: "src/hooks/use-slot-animation.ts"
      provides: "Shared slot-machine animation state machine hook"
      exports: ["useSlotAnimation"]
    - path: "src/app/weekend/page.tsx"
      provides: "Weekend page wired with animation hook"
      contains: "useSlotAnimation"
    - path: "__tests__/use-slot-animation.test.ts"
      provides: "Unit tests for hook state machine with fake timers"
      contains: "vi.useFakeTimers"
    - path: "__tests__/weekend-page.test.tsx"
      provides: "Updated weekend component tests with fake timers"
      contains: "vi.useFakeTimers"
  key_links:
    - from: "src/app/weekend/page.tsx"
      to: "src/hooks/use-slot-animation.ts"
      via: "import { useSlotAnimation } from '@/hooks/use-slot-animation'"
      pattern: "useSlotAnimation"
    - from: "src/app/weekend/page.tsx"
      to: "document keydown event"
      via: "useEffect adding keydown listener when isAnimating"
      pattern: "document.addEventListener.*keydown"
---

<objective>
Create the `useSlotAnimation` hook and wire it into the weekend page to deliver single-slot slot-machine animation.

Purpose: Phase 11 adds a fun cycling animation before revealing the picked restaurant. The hook encapsulates the timer state machine (setInterval cycling + setTimeout settle + skip). Starting with the weekend page (single slot) validates the pattern before the more complex weekday multi-slot integration in plan 11-02.

Output: `src/hooks/use-slot-animation.ts` hook, updated `src/app/weekend/page.tsx` with animation, new hook unit tests, updated weekend page tests.
</objective>

<execution_context>
@/Users/diamond.hung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-wheel-animation/11-RESEARCH.md

@src/hooks/
@src/app/weekend/page.tsx
@__tests__/weekend-page.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSlotAnimation hook</name>
  <files>src/hooks/use-slot-animation.ts</files>
  <action>
Create the directory `src/hooks/` and the file `src/hooks/use-slot-animation.ts`.

The hook signature:

```typescript
'use client'

import { useState, useEffect, useRef, useCallback } from 'react'

interface UseSlotAnimationOptions {
  candidates: string[]       // names to cycle through during animation
  finalValue: string | null  // the pre-computed final pick; null = not yet picked
  durationMs?: number        // total animation time (default 2500)
  intervalMs?: number        // cycling speed (default 80ms)
}

interface UseSlotAnimationResult {
  displayValue: string | null  // what to render in the slot
  isAnimating: boolean
  skip: () => void             // stop immediately and show finalValue
}

export function useSlotAnimation({ candidates, finalValue, durationMs = 2500, intervalMs = 80 }: UseSlotAnimationOptions): UseSlotAnimationResult
```

Implementation requirements:
- Use `useRef` (NOT `useState`) for `intervalRef`, `timeoutRef`, and `prevFinalRef` — avoids stale closure bugs with `clearInterval`/`clearTimeout`
- `prevFinalRef` tracks the last finalValue that triggered animation — prevents re-triggering when parent re-renders with the same finalValue
- `stopAnimation` helper (useCallback, no deps): clears both interval and timeout refs; accepts optional `settledValue: string | null` — if provided, calls `setDisplayValue(settledValue)` and `setIsAnimating(false)`
- `skip` (useCallback, deps: [stopAnimation, finalValue]): calls `stopAnimation(finalValue)`, no-op if `!isAnimating`
- `useEffect` deps: `[finalValue]` ONLY (not candidates, durationMs, intervalMs — these are read inside the effect but must not trigger re-animation)
  - Guard: `if (finalValue === null) return`
  - Guard: `if (finalValue === prevFinalRef.current) return` then update `prevFinalRef.current = finalValue`
  - Guard: `if (candidates.length === 0) { setDisplayValue(finalValue); return }`
  - Call `stopAnimation()` (cancel any running animation) then `setIsAnimating(true)`
  - Start interval cycling through candidates by index, offsetting by 1 each tick
  - Start timeout to call `stopAnimation(finalValue)` after durationMs
  - Return cleanup: `() => stopAnimation()`
- `eslint-disable-line react-hooks/exhaustive-deps` comment on the useEffect dependency array line (intentional — candidates/options are stable references passed by parent)

Do NOT add useMemo import — the hook does not use it. The parent components are responsible for providing stable `candidates` references (via useMemo in the parent).
  </action>
  <verify>Run `npx tsc --noEmit` from the project root — must complete with no errors related to use-slot-animation.ts</verify>
  <done>File exists at src/hooks/use-slot-animation.ts, exports `useSlotAnimation`, TypeScript compiles clean</done>
</task>

<task type="auto">
  <name>Task 2: Wire animation into weekend page + add skip interactions</name>
  <files>src/app/weekend/page.tsx</files>
  <action>
Rewrite `src/app/weekend/page.tsx` to use `useSlotAnimation`. The existing algorithm functions (`pickRandomRestaurant`) remain UNCHANGED — animation only affects display.

State changes:
- Keep: `const [current, setCurrent] = useState<Restaurant | null>(null)` — holds the final pick
- Add: `const candidateNames = useMemo(() => weekendRestaurants.map(r => r.name), [weekendRestaurants])` — stable reference for hook
- Add: `const { displayValue, isAnimating, skip } = useSlotAnimation({ candidates: candidateNames, finalValue: current?.name ?? null })`
- Add new import: `useMemo` from 'react', `useSlotAnimation` from '@/hooks/use-slot-animation'

Handler changes:
- `handleRoll`: unchanged — still calls `setCurrent(pickRandomRestaurant(weekendRestaurants))`; the hook reacts to `current` changing
- `handleReroll`: unchanged — still computes pool, calls `setCurrent(pickRandomRestaurant(pool))`

Add keypress skip effect (in the component body, after hook call):
```typescript
useEffect(() => {
  if (!isAnimating) return
  const handler = (e: KeyboardEvent) => {
    if (['Space', 'Enter', 'Escape'].includes(e.code)) {
      e.preventDefault()
      skip()
    }
  }
  document.addEventListener('keydown', handler)
  return () => document.removeEventListener('keydown', handler)
}, [isAnimating, skip])
```

Button changes:
- Both "隨機推薦" and "換一間" buttons: add `disabled={isAnimating}` prop

Result card area (when `current !== null`):
- Wrap the card in a clickable div: `<div onClick={isAnimating ? skip : undefined} className={isAnimating ? 'cursor-pointer' : ''}>` — clicking during animation skips it
- Show skip hint text when animating: `{isAnimating && <p className="text-xs text-muted-foreground mt-1 text-center">按任意鍵或點擊跳過</p>}`
- The restaurant name (`h2`): show `displayValue` during animation, `current.name` when settled:
  ```tsx
  <h2 className="text-xl font-semibold mb-3">
    {isAnimating ? (displayValue ?? '...') : current.name}
  </h2>
  ```
- The cuisine badge, price, distance, rating `dl`: show skeleton placeholders during animation, real values when settled:
  ```tsx
  {isAnimating ? (
    <div className="space-y-2">
      <div className="h-5 w-16 bg-muted animate-pulse rounded" />
      <div className="h-4 w-24 bg-muted animate-pulse rounded" />
      <div className="h-4 w-20 bg-muted animate-pulse rounded" />
      <div className="h-4 w-16 bg-muted animate-pulse rounded" />
    </div>
  ) : (
    <div className="animate-in fade-in zoom-in-95 duration-300">
      {/* existing cuisine badge + dl with price/distance/rating */}
    </div>
  )}
  ```

The settled card content should be wrapped in `<div className="animate-in fade-in zoom-in-95 duration-300">` so it fades in when revealed — `tw-animate-css` is already imported in globals.css.

Add `useEffect` to imports (it is needed for the keydown handler). `useMemo` also needs to be imported.
  </action>
  <verify>Run `npx tsc --noEmit` — no TypeScript errors. Run `npm run dev` locally and click "隨機推薦" — confirm names cycle for ~2.5s then reveal result card.</verify>
  <done>Weekend page compiles, animation triggers on button click, skip works via click on card and Space/Enter/Escape keypress, result card fades in after settling, buttons disabled during animation</done>
</task>

<task type="auto">
  <name>Task 3: Write hook unit tests + update weekend page tests for fake timers</name>
  <files>__tests__/use-slot-animation.test.ts, __tests__/weekend-page.test.tsx</files>
  <action>
**File 1: `__tests__/use-slot-animation.test.ts`** (NEW)

Test the hook using `renderHook` from `@testing-library/react`. Use `vi.useFakeTimers()` for all tests, restore with `vi.useRealTimers()` in afterEach.

Test cases:
1. **Initial state**: `displayValue` is `null` when `finalValue` is `null`; `isAnimating` is `false`
2. **Starts animating**: When `finalValue` changes from null to a string, `isAnimating` becomes `true` (check immediately after render with new value via `rerender`)
3. **Settles after duration**: After `vi.advanceTimersByTime(2500)`, `isAnimating` is `false` and `displayValue` equals `finalValue`
4. **Skip stops animation**: While animating, call `result.current.skip()`, then assert `isAnimating` is `false` and `displayValue` equals `finalValue`
5. **No re-animation on same finalValue**: If `finalValue` prop does not change between rerenders, `isAnimating` stays `false`
6. **Empty candidates — no animation**: With `candidates: []` and a new `finalValue`, `isAnimating` is `false` and `displayValue` equals `finalValue` immediately

Use `act()` from `@testing-library/react` when advancing timers that trigger state updates:
```typescript
act(() => { vi.advanceTimersByTime(2500) })
```

Import pattern:
```typescript
import { describe, test, expect, vi, afterEach } from 'vitest'
import { renderHook, act } from '@testing-library/react'
import { useSlotAnimation } from '@/hooks/use-slot-animation'
```

**File 2: `__tests__/weekend-page.test.tsx`** (UPDATE)

The existing tests that click "隨機推薦" now trigger an animation that runs for 2500ms. Without fake timers, these tests will time out or the assertions will be wrong (restaurant name will be a cycling placeholder, not the final pick).

Changes required:
- Add `vi` to the import from 'vitest': `import { describe, test, expect, vi } from 'vitest'`
- Add `afterEach` block at the describe level to restore real timers: `afterEach(() => { vi.useRealTimers() })`
- In each test that clicks "隨機推薦" or "換一間":
  1. Change `userEvent.setup()` to `userEvent.setup({ advanceTimers: vi.advanceTimersByTime })`
  2. Add `vi.useFakeTimers()` BEFORE the `renderWeekendPage()` call (timers must be faked before component mounts)
  3. After the button click, advance timers: `act(() => { vi.advanceTimersByTime(3000) })`
  4. Then make assertions about visible restaurant names/prices

Affected tests:
- "roll button picks a restaurant from the pool" — needs fake timers + advance
- "re-roll button appears after first pick but not before" — needs fake timers + advance
- "result card shows restaurant price after rolling" — needs fake timers + advance

Tests that do NOT click pick buttons (title test, empty state test) need NO changes.

Add `act` to imports: `import { render, screen, act } from '@testing-library/react'`
  </action>
  <verify>Run `npx vitest run __tests__/use-slot-animation.test.ts __tests__/weekend-page.test.tsx` — all tests must pass with no timeouts</verify>
  <done>use-slot-animation.test.ts has 6 passing tests covering hook state machine; weekend-page.test.tsx all tests pass with fake timers; no test timeouts</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` — zero TypeScript errors
2. `npx vitest run __tests__/use-slot-animation.test.ts __tests__/weekend-page.test.tsx` — all tests pass
3. `npx vitest run` — full test suite passes (no regressions)
</verification>

<success_criteria>
- `src/hooks/use-slot-animation.ts` exists and exports `useSlotAnimation` with correct TypeScript types
- Weekend page triggers slot animation on "隨機推薦" and "換一間" clicks
- Animation cycles for 2500ms then settles on the pre-computed final pick
- Skip works via click on animating card OR Space/Enter/Escape keypress
- Buttons disabled during animation
- Result card fades in with `animate-in fade-in zoom-in-95 duration-300` when animation settles
- Hook unit tests pass (6 test cases covering state machine)
- Weekend page tests pass with fake timers
- Full vitest run passes
</success_criteria>

<output>
After completion, create `.planning/phases/11-wheel-animation/11-01-SUMMARY.md`
</output>
