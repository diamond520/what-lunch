---
phase: 09-lunch-history
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/history.ts
  - src/lib/history-context.tsx
autonomous: true
requirements:
  - HIST-01
  - HIST-03
  - HIST-05

must_haves:
  truths:
    - "LunchHistoryEntry type exists with id, date (YYYY-MM-DD), restaurantId, restaurantName"
    - "getRecentlyVisitedIds returns restaurant IDs visited within N business days"
    - "splitPoolByHistory returns primary pool (unvisited) and fallback pool (full)"
    - "HistoryContext provides addEntries, removeEntry, clearHistory, entries, lookbackDays, setLookbackDays"
    - "History entries persist across page reloads via localStorage"
    - "HistoryProvider reads from localStorage on mount using the same useSyncExternalStore hydration guard as RestaurantContext"
  artifacts:
    - path: "src/lib/history.ts"
      provides: "Types, localStorage read/write, business day calculation, pool-split functions"
      exports:
        - LunchHistoryEntry
        - HISTORY_STORAGE_KEY
        - LOOKBACK_STORAGE_KEY
        - MAX_HISTORY_ENTRIES
        - readStoredHistory
        - readStoredLookback
        - getRecentlyVisitedIds
        - splitPoolByHistory
    - path: "src/lib/history-context.tsx"
      provides: "HistoryContext, HistoryProvider, useHistory hook"
      exports:
        - HistoryContext
        - HistoryProvider
        - useHistory
  key_links:
    - from: "src/lib/history-context.tsx"
      to: "src/lib/history.ts"
      via: "imports for types and localStorage helpers"
      pattern: "from.*./history"
    - from: "src/lib/history-context.tsx"
      to: "localStorage"
      via: "useEffect writing on entries/lookbackDays change"
      pattern: "localStorage\\.setItem"
---

<objective>
Create the history library and context that underpin all Phase 9 features.

Purpose: Establish the data layer — types, localStorage persistence, business day logic, and pool-split algorithm — before wiring into UI.
Output: `src/lib/history.ts` (pure functions, types) and `src/lib/history-context.tsx` (React context, provider, hook).
</objective>

<execution_context>
@/Users/diamond.hung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/restaurant-context.tsx
@src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/lib/history.ts — types, localStorage, business day logic, pool-split</name>
  <files>src/lib/history.ts</files>
  <action>
Create `src/lib/history.ts` as a pure-function module (no React imports). Define and export:

**Types:**
```ts
export interface LunchHistoryEntry {
  id: string           // crypto.randomUUID()
  date: string         // YYYY-MM-DD local date (not UTC)
  restaurantId: string
  restaurantName: string  // denormalized — survives restaurant deletion
}
```

**Constants:**
```ts
export const HISTORY_STORAGE_KEY = 'what-lunch-history'
export const LOOKBACK_STORAGE_KEY = 'what-lunch-history-lookback'
export const MAX_HISTORY_ENTRIES = 100
export const DEFAULT_LOOKBACK_DAYS = 5
```

**localStorage helpers:**
```ts
export function readStoredHistory(): LunchHistoryEntry[] {
  if (typeof window === 'undefined') return []
  try {
    const stored = localStorage.getItem(HISTORY_STORAGE_KEY)
    return stored ? JSON.parse(stored) : []
  } catch { return [] }
}

export function readStoredLookback(): number {
  if (typeof window === 'undefined') return DEFAULT_LOOKBACK_DAYS
  try {
    const stored = localStorage.getItem(LOOKBACK_STORAGE_KEY)
    const n = stored ? parseInt(stored, 10) : NaN
    return isNaN(n) || n < 1 ? DEFAULT_LOOKBACK_DAYS : n
  } catch { return DEFAULT_LOOKBACK_DAYS }
}
```

**Business day calculation** — `getRecentlyVisitedIds(entries, lookbackDays)`:
- Compute a cutoff date that is `lookbackDays` business days before today (local date)
- Business days = Mon–Fri; skip Sat/Sun when counting backwards
- Use local date strings (YYYY-MM-DD via `new Date().toLocaleDateString('sv')`) to avoid UTC offset issues
- An entry is "recent" if `entry.date >= cutoffDate` (string comparison works for YYYY-MM-DD)
- Return `Set<string>` of restaurantIds that are recent
- Algorithm for cutoff: start from today, decrement day by day, skip weekends, count only business days until reaching `lookbackDays` business days back

```ts
export function getRecentlyVisitedIds(
  entries: LunchHistoryEntry[],
  lookbackDays: number,
): Set<string> { ... }
```

**Pool split** — `splitPoolByHistory(pool, recentIds)`:
- `primary`: restaurants NOT in recentIds
- `fallback`: full pool (all restaurants)
- If primary is empty, callers should use fallback
```ts
export function splitPoolByHistory<T extends { id: string }>(
  pool: T[],
  recentIds: Set<string>,
): { primary: T[]; fallback: T[] } {
  const primary = pool.filter((r) => !recentIds.has(r.id))
  return { primary, fallback: pool }
}
```
  </action>
  <verify>Run `npx tsc --noEmit` from project root — zero TypeScript errors. Confirm exports are importable by checking no circular deps (history.ts imports nothing from src/lib except types.ts if needed — in practice it needs no Restaurant import, only the generic T extends { id: string } pattern).</verify>
  <done>history.ts exists, exports LunchHistoryEntry, HISTORY_STORAGE_KEY, LOOKBACK_STORAGE_KEY, MAX_HISTORY_ENTRIES, DEFAULT_LOOKBACK_DAYS, readStoredHistory, readStoredLookback, getRecentlyVisitedIds, splitPoolByHistory — all with correct TypeScript types and zero tsc errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create src/lib/history-context.tsx — HistoryContext, HistoryProvider, useHistory</name>
  <files>src/lib/history-context.tsx</files>
  <action>
Create `src/lib/history-context.tsx` following the exact pattern of `src/lib/restaurant-context.tsx` (React 19 context, useSyncExternalStore hydration guard, useEffect persistence).

**Interface:**
```ts
interface HistoryContextValue {
  entries: LunchHistoryEntry[]
  lookbackDays: number
  isHydrated: boolean
  addEntries: (newEntries: LunchHistoryEntry[]) => void  // adds multiple at once (confirming a 5-day plan)
  removeEntry: (id: string) => void
  clearHistory: () => void
  setLookbackDays: (n: number) => void
}
```

**Implementation details:**
- `'use client'` directive at top
- Import: `createContext, useContext, useState, useEffect, useSyncExternalStore` from 'react'
- Import: `LunchHistoryEntry, HISTORY_STORAGE_KEY, LOOKBACK_STORAGE_KEY, MAX_HISTORY_ENTRIES, readStoredHistory, readStoredLookback` from `./history`
- Initialize state with lazy initializers (same as RestaurantContext): `useState<LunchHistoryEntry[]>(readStoredHistory)` and `useState<number>(readStoredLookback)`
- `useSyncExternalStore` hydration guard — identical pattern to RestaurantContext: `useSyncExternalStore(() => () => {}, () => true, () => false)`
- `useEffect` for entries: persist to `HISTORY_STORAGE_KEY` when entries changes (guard: `if (!isHydrated) return`)
- `useEffect` for lookbackDays: persist to `LOOKBACK_STORAGE_KEY` when lookbackDays changes (guard: same)
- `addEntries`: prepend newEntries then slice to MAX_HISTORY_ENTRIES: `setEntries(prev => [...newEntries, ...prev].slice(0, MAX_HISTORY_ENTRIES))`
- `removeEntry`: filter by id
- `clearHistory`: set to []
- `setLookbackDays`: clamp to minimum 1, set state

**React 19 context syntax** (per project decision — not .Provider):
```tsx
export const HistoryContext = createContext<HistoryContextValue | null>(null)
// ...in JSX:
<HistoryContext value={{ entries, lookbackDays, isHydrated, addEntries, removeEntry, clearHistory, setLookbackDays }}>
  {children}
</HistoryContext>
```

**Hook:**
```ts
export function useHistory(): HistoryContextValue {
  const ctx = useContext(HistoryContext)
  if (!ctx) throw new Error('useHistory must be used within HistoryProvider')
  return ctx
}
```
  </action>
  <verify>Run `npx tsc --noEmit` — zero errors. Confirm `HistoryProvider` and `useHistory` are exported.</verify>
  <done>history-context.tsx exists, exports HistoryProvider and useHistory, follows RestaurantContext pattern (React 19 syntax, useSyncExternalStore hydration guard, useEffect persistence), zero TypeScript errors.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors after both tasks
- `src/lib/history.ts` exports: LunchHistoryEntry, HISTORY_STORAGE_KEY, LOOKBACK_STORAGE_KEY, MAX_HISTORY_ENTRIES, DEFAULT_LOOKBACK_DAYS, readStoredHistory, readStoredLookback, getRecentlyVisitedIds, splitPoolByHistory
- `src/lib/history-context.tsx` exports: HistoryContext, HistoryProvider, useHistory
- No imports from React in history.ts (pure functions only)
- No imports from history-context in history.ts (no circular dependency)
</verification>

<success_criteria>
Both files exist, compile cleanly, and follow established codebase patterns. The pure functions in history.ts are ready for unit testing in plan 09-03. The HistoryProvider is ready to be wired into layout.tsx in plan 09-02.
</success_criteria>

<output>
After completion, create `.planning/phases/09-lunch-history/09-01-SUMMARY.md`
</output>
