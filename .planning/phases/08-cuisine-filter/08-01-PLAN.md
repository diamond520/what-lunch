---
phase: 08-cuisine-filter
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/recommend.ts
  - __tests__/recommend.test.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "applyFilter('exclude', ['jp']) removes all Japanese restaurants from pool"
    - "applyFilter('lock', ['chi']) keeps only Chinese restaurants in pool"
    - "applyFilter with empty selected array returns original pool unchanged"
    - "generateWeeklyPlan with relaxDiversity=true produces a plan even when pool has only one cuisine type"
    - "rerollSlot with relaxDiversity=true picks from a single-cuisine pool without failing"
    - "Existing tests still pass — no regressions in generateWeeklyPlan or rerollSlot"
  artifacts:
    - path: "src/lib/recommend.ts"
      provides: "applyFilter helper, FilterMode type, relaxDiversity option on generateWeeklyPlan and rerollSlot"
      exports: ["applyFilter", "FilterMode", "generateWeeklyPlan", "rerollSlot"]
    - path: "__tests__/recommend.test.ts"
      provides: "Tests for applyFilter and relaxDiversity behavior"
      min_lines: 50
  key_links:
    - from: "src/lib/recommend.ts"
      to: "src/lib/types.ts"
      via: "CuisineType import for applyFilter signature"
      pattern: "import.*CuisineType.*from.*types"
    - from: "__tests__/recommend.test.ts"
      to: "src/lib/recommend.ts"
      via: "import applyFilter and FilterMode"
      pattern: "import.*applyFilter.*from.*recommend"
---

<objective>
Add cuisine pool filtering (`applyFilter`) and diversity relaxation (`relaxDiversity`) to the recommendation algorithm via TDD.

Purpose: The picker page needs to narrow the restaurant pool before calling `generateWeeklyPlan` / `rerollSlot`, and needs to relax the no-3-consecutive cuisine rule when lock mode has only 1 cuisine type selected.

Output: `applyFilter` pure function, `FilterMode` type export, `relaxDiversity` option on `generateWeeklyPlan` and `rerollSlot` — all tested.
</objective>

<execution_context>
@/Users/diamond.hung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/recommend.ts
@src/lib/types.ts
@__tests__/recommend.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD applyFilter + relaxDiversity in recommend.ts</name>
  <files>src/lib/recommend.ts, __tests__/recommend.test.ts</files>
  <action>
Follow RED-GREEN-REFACTOR for each feature:

**Feature 1: applyFilter helper**

RED — Add tests to `__tests__/recommend.test.ts` in a new `describe('applyFilter')` block:
1. `applyFilter('exclude', ['jp'], pool)` returns pool without Japanese restaurants
2. `applyFilter('exclude', ['jp', 'kr'], pool)` removes both Japanese and Korean
3. `applyFilter('lock', ['chi'], pool)` returns only Chinese restaurants
4. `applyFilter('lock', ['chi', 'west'], pool)` returns Chinese and Western only
5. `applyFilter('exclude', [], pool)` returns full pool (no-op)
6. `applyFilter('lock', [], pool)` returns full pool (no-op — lock with nothing selected means no restriction)

Use a small test pool of 5 restaurants (one per cuisine type) defined at the top of the describe block. Import `applyFilter` and `FilterMode` from `@/lib/recommend`.

Run tests — they MUST fail (applyFilter does not exist yet).
Commit: `test(08-01): add failing tests for applyFilter`

GREEN — In `src/lib/recommend.ts`:
1. Export `type FilterMode = 'exclude' | 'lock'`
2. Import `CuisineType` from `./types`
3. Export `applyFilter(pool: Restaurant[], mode: FilterMode, selected: CuisineType[]): Restaurant[]`:
   - If `selected.length === 0`, return `pool` unchanged
   - If `mode === 'exclude'`, return `pool.filter(r => !selected.includes(r.type))`
   - If `mode === 'lock'`, return `pool.filter(r => selected.includes(r.type))`

Run tests — they MUST pass.
Commit: `feat(08-01): implement applyFilter helper`

**Feature 2: relaxDiversity option on generateWeeklyPlan + rerollSlot**

RED — Add tests in a new `describe('relaxDiversity')` block:
1. Create a pool of 5 restaurants all with type `'chi'` (Chinese only, varying prices)
2. Test: `generateWeeklyPlan(chiPool, 1000, { relaxDiversity: true })` returns a valid plan (5 days, totalCost <= 1000) — without relaxDiversity this would hit cuisine violations constantly
3. Test: `rerollSlot(plan, 2, chiPool, { relaxDiversity: true })` returns a valid plan — slot 2 is replaced
4. Test: existing behavior unchanged — `generateWeeklyPlan(mixedPool, 1000)` still produces plans without 3-consecutive violations (run 20 times to verify statistically)

Run tests — they MUST fail (signatures don't accept options yet).
Commit: `test(08-01): add failing tests for relaxDiversity`

GREEN — In `src/lib/recommend.ts`:
1. Add `relaxDiversity = false` parameter to `hasCuisineViolation`:
   ```typescript
   function hasCuisineViolation(
     plan: Restaurant[],
     slotIndex: number,
     candidate: Restaurant,
     relaxDiversity = false,
   ): boolean {
     if (relaxDiversity) return false
     // ... existing logic unchanged
   }
   ```
2. Add `relaxDiversity = false` parameter to `pickForSlot`, pass through to `hasCuisineViolation`:
   ```typescript
   function pickForSlot(
     pool: Restaurant[], remainingBudget: number, planSoFar: Restaurant[],
     slotIndex: number, slotsRemaining: number, relaxDiversity = false,
   ): Restaurant {
     const eligible = pool.filter(
       (r) => r.price <= spendableNow && !hasCuisineViolation(planSoFar, slotIndex, r, relaxDiversity),
     )
     // ... rest unchanged
   }
   ```
3. Add `relaxDiversity = false` parameter to `pickForSlotReroll`, pass through to `hasCuisineViolation`:
   ```typescript
   function pickForSlotReroll(
     pool: Restaurant[], remaining: number, fullPlan: Restaurant[],
     slotIndex: number, relaxDiversity = false,
   ): Restaurant {
     const eligible = pool.filter(
       (r) => r.price <= remaining && !hasCuisineViolation(fullPlan, slotIndex, r, relaxDiversity),
     )
     // ... rest unchanged
   }
   ```
4. Change `generateWeeklyPlan` signature to accept optional options object:
   ```typescript
   export function generateWeeklyPlan(
     pool: Restaurant[], weeklyBudget: number,
     options?: { relaxDiversity?: boolean },
   ): WeeklyPlan
   ```
   In `generatePlanAttempt`, pass `relaxDiversity` through. Accept options in `generatePlanAttempt` too and pass to `pickForSlot`.
5. Change `rerollSlot` signature to accept optional options object:
   ```typescript
   export function rerollSlot(
     plan: WeeklyPlan, slotIndex: number, pool: Restaurant[],
     options?: { relaxDiversity?: boolean },
   ): WeeklyPlan
   ```
   Pass `options?.relaxDiversity` to `pickForSlotReroll`.

Run all tests — they MUST pass including all existing tests (no regressions).
Commit: `feat(08-01): add relaxDiversity option to generateWeeklyPlan and rerollSlot`

**Important notes:**
- Do NOT change any existing function's default behavior. All new parameters default to `false` or `undefined`.
- The `hasConsecutiveCuisineViolation` function used in the retry loop of `generateWeeklyPlan` should also respect `relaxDiversity` — if `relaxDiversity` is true, skip the retry loop entirely (all plans are valid when diversity is relaxed).
- Existing tests must pass unchanged — they call functions without the new options, which default to current behavior.
  </action>
  <verify>
Run `npx vitest run __tests__/recommend.test.ts` — all tests pass (existing + new).
Run `npx tsc --noEmit` — no TypeScript errors.
  </verify>
  <done>
`applyFilter` is exported from recommend.ts and correctly filters pools by exclude/lock mode.
`FilterMode` type is exported from recommend.ts.
`generateWeeklyPlan` and `rerollSlot` accept `{ relaxDiversity?: boolean }` option.
When `relaxDiversity: true`, the cuisine diversity constraint is skipped entirely.
All existing tests pass without modification.
New tests cover applyFilter (6 cases) and relaxDiversity (3-4 cases).
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run __tests__/recommend.test.ts` — all tests pass
2. `npx tsc --noEmit` — no type errors
3. Existing generateWeeklyPlan and rerollSlot tests pass unchanged (no regressions)
4. New applyFilter tests verify both exclude and lock modes
5. New relaxDiversity tests verify single-cuisine pool works with the flag
</verification>

<success_criteria>
- applyFilter is exported and unit-tested with 6+ test cases
- FilterMode type is exported
- generateWeeklyPlan accepts { relaxDiversity?: boolean } option
- rerollSlot accepts { relaxDiversity?: boolean } option
- All existing tests pass without modification
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/08-cuisine-filter/08-01-SUMMARY.md`
</output>
