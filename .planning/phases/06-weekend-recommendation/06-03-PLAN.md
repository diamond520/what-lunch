---
phase: 06-weekend-recommendation
plan: 03
type: execute
wave: 3
depends_on: ["06-01", "06-02"]
files_modified:
  - __tests__/weekend.test.ts
  - __tests__/weekend-page.test.tsx
autonomous: true

must_haves:
  truths:
    - "pickRandomRestaurant is tested: returns element from pool, throws on empty, produces varied results"
    - "WeekendPage component is tested: empty state, roll, re-roll, result card rendering"
  artifacts:
    - path: "__tests__/weekend.test.ts"
      provides: "Unit tests for pickRandomRestaurant"
      contains: "pickRandomRestaurant"
    - path: "__tests__/weekend-page.test.tsx"
      provides: "Component tests for WeekendPage"
      contains: "WeekendPage"
  key_links:
    - from: "__tests__/weekend.test.ts"
      to: "src/lib/recommend.ts"
      via: "imports pickRandomRestaurant"
      pattern: "import.*pickRandomRestaurant"
    - from: "__tests__/weekend-page.test.tsx"
      to: "src/app/weekend/page.tsx"
      via: "imports WeekendPage component"
      pattern: "import.*weekend"
---

<objective>
Write tests for the weekend feature: unit tests for pickRandomRestaurant and component tests for the WeekendPage.

Purpose: Ensure the weekend random pick logic and page behavior are verified, catching regressions in edge cases like empty pool, single-item pool, and re-roll exclusion.
Output: Two new test files with comprehensive coverage of weekend feature behavior.
</objective>

<execution_context>
@/Users/diamond.hung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-weekend-recommendation/06-RESEARCH.md
@.planning/phases/06-weekend-recommendation/06-01-SUMMARY.md
@.planning/phases/06-weekend-recommendation/06-02-SUMMARY.md

@src/lib/recommend.ts
@src/app/weekend/page.tsx
@src/lib/restaurant-context.tsx
@src/lib/types.ts
@__tests__/restaurants.test.tsx
@vitest.config.mts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for pickRandomRestaurant</name>
  <files>__tests__/weekend.test.ts</files>
  <action>
Create `__tests__/weekend.test.ts` with unit tests for the `pickRandomRestaurant` function. Follow the existing `recommend.test.ts` pattern (vitest, node environment).

Test cases:
1. **Returns a restaurant from the pool:** Given a pool of 2+ restaurants, the result is contained in the pool (`expect(pool).toContainEqual(result)`)
2. **Throws on empty pool:** `expect(() => pickRandomRestaurant([])).toThrow('Restaurant pool cannot be empty')`
3. **Returns the only item when pool has one entry:** `expect(pickRandomRestaurant([pool[0]])).toBe(pool[0])`
4. **Produces varied results over many calls:** Run 50 iterations with a pool of 5, collect unique IDs into a Set, assert `size > 1` (probabilistic but extremely unlikely to fail)

Use test data:
```typescript
const pool: Restaurant[] = [
  { id: 'w1', name: '假日餐廳A', type: 'west', price: 400, distance: 1000, rating: 4.5 },
  { id: 'w2', name: '假日餐廳B', type: 'jp', price: 350, distance: 800, rating: 4.3 },
  { id: 'w3', name: '假日餐廳C', type: 'chi', price: 200, distance: 600, rating: 4.0 },
]
```

Import pattern:
```typescript
import { describe, test, expect } from 'vitest'
import { pickRandomRestaurant } from '@/lib/recommend'
import type { Restaurant } from '@/lib/types'
```

Do NOT use `vi.fn()` or mocks — this is a pure function test.
  </action>
  <verify>
    `npx vitest run __tests__/weekend.test.ts` — all tests pass
  </verify>
  <done>
    - 4 test cases covering: pool membership, empty pool error, single-item pool, randomness distribution
    - All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Component tests for WeekendPage</name>
  <files>__tests__/weekend-page.test.tsx</files>
  <action>
Create `__tests__/weekend-page.test.tsx` with component tests for the WeekendPage. Follow the existing `restaurants.test.tsx` pattern (vitest + RTL + jsdom environment).

1. **Setup helper** — `renderWeekendPage` wraps the component in RestaurantContext with mock values:
   ```typescript
   import { describe, test, expect, vi } from 'vitest'
   import { render, screen } from '@testing-library/react'
   import userEvent from '@testing-library/user-event'
   import { RestaurantContext } from '@/lib/restaurant-context'
   import WeekendPage from '@/app/weekend/page'
   import type { Restaurant } from '@/lib/types'

   const mockWeekendRestaurants: Restaurant[] = [
     { id: 'wknd-1', name: '假日燒肉', type: 'jp', price: 500, distance: 1200, rating: 4.5 },
     { id: 'wknd-2', name: '假日火鍋', type: 'chi', price: 350, distance: 900, rating: 4.2 },
   ]

   function renderWeekendPage(weekendRestaurants: Restaurant[] = mockWeekendRestaurants) {
     return render(
       <RestaurantContext
         value={{
           restaurants: [],
           weekendRestaurants,
           isHydrated: true,
           addRestaurant: vi.fn(),
           removeRestaurant: vi.fn(),
           updateRestaurant: vi.fn(),
           addWeekendRestaurant: vi.fn(),
           removeWeekendRestaurant: vi.fn(),
           updateWeekendRestaurant: vi.fn(),
         }}
       >
         <WeekendPage />
       </RestaurantContext>,
     )
   }
   ```

2. **Test cases:**

   a. **Shows page title:** Renders "假日推薦" heading
      ```typescript
      renderWeekendPage()
      expect(screen.getByRole('heading', { name: '假日推薦' })).toBeInTheDocument()
      ```

   b. **Empty state — shows prompt with link:** When pool is empty, shows message and link to /restaurants
      ```typescript
      renderWeekendPage([])
      expect(screen.getByText(/尚未新增假日餐廳/)).toBeInTheDocument()
      expect(screen.getByRole('link', { name: /餐廳管理/ })).toHaveAttribute('href', '/restaurants')
      ```
      Note: The exact link text may vary — use a regex matcher. The important thing is a link to `/restaurants` exists.

   c. **Roll button picks a restaurant:** Click "隨機推薦", a restaurant name from the pool appears
      ```typescript
      renderWeekendPage()
      const user = userEvent.setup()
      await user.click(screen.getByRole('button', { name: /隨機推薦/ }))
      const names = mockWeekendRestaurants.map(r => r.name)
      const displayed = names.find(n => screen.queryByText(n))
      expect(displayed).toBeDefined()
      ```

   d. **Re-roll button appears after first pick:** Before clicking roll, no "換一間" button visible. After clicking roll, "換一間" button appears.
      ```typescript
      renderWeekendPage()
      const user = userEvent.setup()
      expect(screen.queryByRole('button', { name: /換一間/ })).not.toBeInTheDocument()
      await user.click(screen.getByRole('button', { name: /隨機推薦/ }))
      expect(screen.getByRole('button', { name: /換一間/ })).toBeInTheDocument()
      ```

   e. **Result card shows restaurant details:** After rolling, the result displays cuisine badge, price, and distance
      ```typescript
      renderWeekendPage()
      const user = userEvent.setup()
      await user.click(screen.getByRole('button', { name: /隨機推薦/ }))
      // At least one of the mock restaurants' prices should appear
      const priceVisible = screen.queryByText(/500/) || screen.queryByText(/350/)
      expect(priceVisible).toBeInTheDocument()
      ```

   **Note on button text matching:** The actual button text in the WeekendPage may differ slightly. Read `src/app/weekend/page.tsx` first to confirm exact button labels before writing tests. Adjust regex matchers accordingly.

   **Note on environment:** This test file needs jsdom environment. If the vitest config does not default to jsdom for .tsx files, add a file-level comment: `// @vitest-environment jsdom`
  </action>
  <verify>
    - `npx vitest run __tests__/weekend-page.test.tsx` — all tests pass
    - `npx vitest run` — ALL tests pass (full suite, no regressions)
  </verify>
  <done>
    - WeekendPage component tests cover: page title, empty state with link, roll picks restaurant, re-roll button visibility, result card details
    - All tests pass
    - Full test suite passes with no regressions
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` — full test suite passes (all files including new weekend tests)
2. `npx tsc --noEmit` — no TypeScript errors in test files
3. Test count increased by ~9-10 tests (4 unit + 5 component)
</verification>

<success_criteria>
- pickRandomRestaurant has 4 unit tests covering core behavior and edge cases
- WeekendPage has 5 component tests covering empty state, roll, re-roll, and result rendering
- Full test suite passes with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/06-weekend-recommendation/06-03-SUMMARY.md`
</output>
