# Phase 1: Foundation - Research

**Researched:** 2026-02-18
**Domain:** Next.js App Router + TypeScript data model + shadcn/ui scaffold
**Confidence:** HIGH

## Summary

This phase establishes the Next.js project scaffold and a single typed source of truth for all restaurant data. The primary technical challenge is not scaffolding (which is automated via `create-next-app` + `npx shadcn@latest init`) but rather eliminating the type duplication bug that existed in the old Vue 2 codebase, where cuisine labels and colors were defined separately in three places (`main.js` filter, `store/index.js` state, and implicitly in component templates).

The standard approach is: (1) define `CuisineType` as a TypeScript union type derived from `as const` object keys, (2) co-locate labels and colors in a single `CUISINE_META` record, (3) export all 19 restaurants as a typed `Restaurant[]` constant from `lib/restaurants.ts`. The scaffold uses `create-next-app@latest` (currently produces Next.js 16.1.6 — see Open Questions) with the `--yes` flag enabling TypeScript, Tailwind CSS v4, ESLint, App Router, and Turbopack by default. shadcn/ui is then initialized with `npx shadcn@latest init` selecting the `new-york` style.

**Primary recommendation:** Use `create-next-app@latest --yes` to scaffold, then `npx shadcn@latest init`, then hand-write `lib/types.ts` and `lib/restaurants.ts` as the single source of truth for all restaurant data and cuisine constants.

---

## Standard Stack

### Core

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| next | 16.1.6 (latest) or 15.x if pinned | App Router framework | Required by prior decisions; Vercel native |
| react | 19.2.4 | UI rendering | Bundled with Next.js App Router |
| react-dom | 19.2.4 | DOM rendering | Required peer of react |
| typescript | 5.9.3 | Type safety | Locked decision; catches price/distance coercion bugs |
| tailwindcss | 4.1.18 | Utility CSS | Locked decision; v4 is now default from create-next-app |

### Supporting (shadcn/ui)

| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| shadcn (CLI) | 3.8.5 | Component scaffolding | Run once at init; not a runtime dep |
| radix-ui | latest | Headless UI primitives | shadcn new-york style now uses unified `radix-ui` package (not @radix-ui/react-*) |
| class-variance-authority | latest | Component variant API | Auto-installed by shadcn init |
| clsx + tailwind-merge | latest | cn() utility | Auto-installed by shadcn init into lib/utils.ts |
| lucide-react | latest | Icons | shadcn default icon library |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Next.js 16 (latest) | Next.js 15 (pinned) | Pinning 15 avoids async params change risk but misses Turbopack stable + React 19.2; see Open Questions |
| Tailwind v4 (default) | Tailwind v3 | v4 has no `tailwind.config.js` — shadcn CLI handles this automatically |
| `new-york` style | `default` style | `default` style is deprecated in shadcn; always use `new-york` |
| TypeScript union type | string type | Union type makes `type` field checked at compile time |

### Installation

```bash
# Step 1: Scaffold (produces Next.js 16 + Tailwind v4 + TypeScript + ESLint + App Router)
npx create-next-app@latest what-lunch --yes

# Step 2: Initialize shadcn/ui (interactive — choose: new-york, neutral, css variables: yes)
npx shadcn@latest init

# Step 3: No additional packages needed for Phase 1
# lib/types.ts and lib/restaurants.ts are pure TypeScript, no deps
```

---

## Architecture Patterns

### Recommended Project Structure

```
what-lunch/
├── app/
│   ├── layout.tsx          # Root layout (html + body, Tailwind globals)
│   ├── page.tsx            # Home page (Server Component by default)
│   └── globals.css         # Tailwind v4 @import + CSS vars (shadcn theme)
├── components/
│   └── ui/                 # shadcn/ui generated components (button, card, etc.)
├── lib/
│   ├── types.ts            # Restaurant interface, CuisineType union, CUISINE_META
│   ├── restaurants.ts      # DEFAULT_RESTAURANTS constant (typed Restaurant[])
│   └── utils.ts            # shadcn cn() utility (auto-generated by init)
├── public/                 # Static assets
├── next.config.ts          # Next.js config (TypeScript since v15)
├── tsconfig.json           # TypeScript config (strict: true)
├── components.json         # shadcn/ui configuration
└── package.json
```

### Pattern 1: Single-File Types + Constants (FOUND-01 + FOUND-02)

**What:** Define the `CuisineType` union type derived from a `CUISINE_META` constant using `keyof typeof`. Labels and colors live once in the same object.

**When to use:** Whenever 2+ string values need to be both a type constraint AND runtime lookup data.

**Example:**
```typescript
// lib/types.ts
// Source: TypeScript handbook + verified pattern from https://chrisvaillancourt.io/posts/combining-typescript-satisfies-and-const-assertion/

export const CUISINE_META = {
  chi: { label: '中式', color: '#67C23A' },
  jp:  { label: '日式', color: '#E6A23C' },
  kr:  { label: '韓式', color: '#F56C6C' },
  tai: { label: '泰式', color: '#909399' },
  west:{ label: '西式', color: '#109399' },
} as const satisfies Record<string, { label: string; color: string }>

// CuisineType is inferred as 'chi' | 'jp' | 'kr' | 'tai' | 'west'
export type CuisineType = keyof typeof CUISINE_META

export interface Restaurant {
  id: string
  name: string
  type: CuisineType    // enforced at compile time
  price: number        // explicit number (fixes Vue 2 string/number coercion bug)
  distance: number     // meters, explicit number
}
```

**Why `as const satisfies` over just `as const`:**
- `as const` alone: TypeScript infers literal types but provides no shape validation
- `satisfies Record<...>`: TypeScript validates each entry matches the shape AND preserves literal narrowing
- Together: you get both shape safety and literal key inference for the union type

### Pattern 2: Typed Constant Array (FOUND-03)

**What:** Export restaurants as a typed `readonly` constant, not as a mutable array.

**When to use:** Static data that should never be mutated; enables TypeScript to verify each entry.

**Example:**
```typescript
// lib/restaurants.ts
// Source: TypeScript as const + satisfies pattern

import type { Restaurant } from './types'

export const DEFAULT_RESTAURANTS = [
  { id: 'id-1',  name: '鼎泰豐',   type: 'chi',  price: 120, distance: 150 },
  { id: 'id-2',  name: '一蘭拉麵', type: 'jp',   price: 100, distance: 150 },
  { id: 'id-3',  name: '西提',     type: 'west', price: 160, distance: 250 },
  { id: 'id-4',  name: '韓國郎',   type: 'kr',   price: 115, distance: 150 },
  { id: 'id-5',  name: 'Sukiya',   type: 'jp',   price: 100, distance: 50  },
  { id: 'id-6',  name: '王品',     type: 'west', price: 120, distance: 400 },
  { id: 'id-7',  name: '瓦城',     type: 'tai',  price: 85,  distance: 110 },
  { id: 'id-8',  name: '吉野家',   type: 'jp',   price: 70,  distance: 310 },
  { id: 'id-9',  name: '我家牛排', type: 'west', price: 105, distance: 90  },
  { id: 'id-10', name: '小食泰',   type: 'tai',  price: 65,  distance: 850 },
  { id: 'id-11', name: '迴轉壽司', type: 'jp',   price: 70,  distance: 240 },
  { id: 'id-12', name: '夏慕尼',   type: 'west', price: 130, distance: 150 },
  { id: 'id-13', name: '打拋專賣', type: 'tai',  price: 150, distance: 510 },
  { id: 'id-14', name: '日式燒肉', type: 'jp',   price: 125, distance: 190 },
  { id: 'id-15', name: '義麵屋',   type: 'west', price: 145, distance: 380 },
  { id: 'id-16', name: '湄南小鎮', type: 'tai',  price: 105, distance: 110 },
  { id: 'id-17', name: '丼飯',     type: 'jp',   price: 100, distance: 10  },
  { id: 'id-18', name: '漢堡王',   type: 'west', price: 110, distance: 150 },
  { id: 'id-19', name: '熱炒100',  type: 'chi',  price: 90,  distance: 290 },
] satisfies Restaurant[]
```

**Why `satisfies Restaurant[]` not `: Restaurant[]`:**
- `: Restaurant[]` widens types — `type` becomes `string`, losing literal narrowing
- `satisfies Restaurant[]` validates the shape while keeping inferred literal types
- TypeScript will error if any entry has an invalid `type` value (e.g., `'chinese'` instead of `'chi'`)
- TypeScript will error if `price` or `distance` are strings (fixes the Vue 2 bug)

### Pattern 3: Next.js App Router Server Component Default

**What:** All files in `app/` are Server Components by default. Only add `'use client'` when the component needs interactivity (useState, useEffect, event handlers).

**When to use:** For Phase 1 foundation only — `app/page.tsx` just needs to render without errors. No interactivity in Phase 1.

**Example:**
```typescript
// app/page.tsx — Server Component (no 'use client' needed)
// Source: https://nextjs.org/docs/app/getting-started/server-and-client-components

import { DEFAULT_RESTAURANTS } from '@/lib/restaurants'

export default function HomePage() {
  return (
    <main>
      <h1>What Lunch?</h1>
      <p>{DEFAULT_RESTAURANTS.length} restaurants available</p>
    </main>
  )
}
```

### Pattern 4: shadcn/ui Init with Tailwind v4

**What:** Tailwind v4 uses CSS-first configuration (no `tailwind.config.js`). shadcn/ui CLI handles this automatically.

**What the CLI creates for Tailwind v4:**
- No `tailwind.config.js` or `tailwind.config.ts` (removed in v4)
- CSS configuration via `@import "tailwindcss"` + `@theme` directive in `globals.css`
- `components.json` with `"style": "new-york"`, `"tailwind.cssVariables": true`

```css
/* app/globals.css — generated by shadcn init for Tailwind v4 */
@import "tailwindcss";
@import "tw-animate-css";

@custom-variant dark (&:is(.dark *));

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  /* ... shadcn color tokens ... */
}
```

### Anti-Patterns to Avoid

- **Duplicating cuisine labels/colors:** Never define `'chi': '中式'` anywhere except `CUISINE_META` in `lib/types.ts`. No switch statements, no inline maps.
- **Importing JSON directly:** The old codebase used `import dishes from './dishes.json'`. Use `lib/restaurants.ts` instead — JSON imports lose type safety for union types.
- **Using `: Restaurant[]` annotation:** This widens types and loses the compile-time check that `type` values are valid `CuisineType`s. Use `satisfies Restaurant[]` instead.
- **Adding `'use client'` to `lib/` files:** Data constants and types are server-safe. Never add directives to non-component files.
- **Modifying `next-env.d.ts`:** This file is auto-generated by Next.js and overwritten on each build. Put custom type declarations in a separate `.d.ts` file and reference it in `tsconfig.json`.
- **Using `tailwind.config.js` with Tailwind v4:** Tailwind v4 uses CSS-first configuration. The config file no longer exists.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| CSS utility merging | Custom merge function | `cn()` from `lib/utils.ts` (clsx + tailwind-merge) | Tailwind class conflicts (e.g., `text-red-500 text-blue-500`) need merge logic |
| UI component variants | Custom variant system | `class-variance-authority` (shadcn uses it) | Handles boolean, compound, and default variants safely |
| TypeScript path aliases | Relative `../../lib/` imports | `@/` alias via `tsconfig.json` paths | Auto-configured by `create-next-app`; shadcn expects it |
| Color/label lookups | Switch statements or inline maps | `CUISINE_META[type].label` pattern | Switch breaks when you add a new cuisine; CUISINE_META causes a TS error |

**Key insight:** The cuisine type system (labels + colors + union type) looks trivial but has already caused production bugs in the old codebase. The `as const satisfies Record<>` pattern prevents re-introduction of these bugs at zero runtime cost.

---

## Common Pitfalls

### Pitfall 1: Next.js 16 Async params/searchParams

**What goes wrong:** In Next.js 15+ (finalized in 16 as a breaking change), `params` and `searchParams` in page components are Promises. Accessing them synchronously causes errors.

**Why it happens:** Next.js 15 made dynamic APIs async to improve static rendering performance. Phase 1 has no dynamic routes, so this does NOT affect Phase 1 directly — but future phases will hit it.

**How to avoid:** When future pages use params: `const { id } = await params` (Server Components) or `const { id } = React.use(params)` (Client Components).

**Warning signs:** TypeScript error `Type 'Promise<PageProps>' is not assignable to 'PageProps'` when accessing `props.params.slug` synchronously.

### Pitfall 2: TypeScript Strict Mode Not Enabled by Default

**What goes wrong:** `create-next-app` does NOT enable TypeScript strict mode by default. The `strict` flag catches the price/distance string-vs-number coercion bug from the old Vue 2 app.

**Why it happens:** Next.js scaffolds with `"strict": false` to minimize friction for new users.

**How to avoid:** After `create-next-app`, immediately set `"strict": true` in `tsconfig.json`. The `satisfies Restaurant[]` pattern will then catch any data entries with string prices.

**Warning signs:** TypeScript accepts `price: "120"` without error when strict is off.

### Pitfall 3: shadcn `default` Style is Deprecated

**What goes wrong:** Running `npx shadcn@latest init` and selecting `default` style installs a deprecated theme that won't receive updates.

**Why it happens:** shadcn renamed their styles; `default` was replaced by `new-york` as the canonical style.

**How to avoid:** Always select `new-york` during `shadcn init` prompts. Verified at https://ui.shadcn.com/docs/components-json.

**Warning signs:** `"style": "default"` in `components.json`.

### Pitfall 4: Tailwind v4 Has No `tailwind.config.js`

**What goes wrong:** Developers try to customize Tailwind by creating a `tailwind.config.js` file, or copy config patterns from v3 tutorials.

**Why it happens:** Tailwind v4 (released January 2025) moved to CSS-first configuration via `@theme` directive. The JavaScript config file no longer works.

**How to avoid:** All theme customization goes in `globals.css` under `@theme { }`. The shadcn CLI generates the correct CSS automatically.

**Warning signs:** `tailwind.config.js` present in project root; Tailwind utilities not applying.

### Pitfall 5: Cuisine Type in JSON vs TypeScript

**What goes wrong:** Importing the old `dishes.json` directly and using its `type` field as a string. TypeScript won't validate `"chi"` against `CuisineType` without explicit typing.

**Why it happens:** JSON imports produce `string` types for string values, not literal types.

**How to avoid:** Do NOT use `dishes.json` at all in the new codebase. The 19 restaurants are hand-migrated into `lib/restaurants.ts` with the `satisfies Restaurant[]` annotation. Delete or ignore `src/store/dishes.json`.

**Warning signs:** `type` field typed as `string` instead of `CuisineType` in any file.

### Pitfall 6: `next-env.d.ts` Must Not Be Committed

**What goes wrong:** Committing `next-env.d.ts` to git causes merge conflicts and stale type declarations.

**Why it happens:** Next.js regenerates this file on every `next dev` / `next build`. It is specific to the local build.

**How to avoid:** Ensure `.gitignore` includes `next-env.d.ts`. `create-next-app` does this automatically.

**Warning signs:** `next-env.d.ts` appears in `git status` after running `next dev`.

---

## Code Examples

Verified patterns from official sources:

### TypeScript Config (strict enabled)

```json
// tsconfig.json — enable strict immediately after create-next-app
// Source: https://nextjs.org/docs/app/api-reference/config/typescript
{
  "compilerOptions": {
    "strict": true,
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "module": "esnext",
    "target": "ES2017",
    "jsx": "preserve",
    "noEmit": true,
    "incremental": true,
    "paths": {
      "@/*": ["./*"]
    },
    "plugins": [{ "name": "next" }]
  },
  "include": ["next-env.d.ts", ".next/types/**/*.ts", "**/*.ts", "**/*.tsx"],
  "exclude": ["node_modules"]
}
```

### next.config.ts (TypeScript, not .js)

```typescript
// next.config.ts — Next.js 15+ supports .ts config natively
// Source: https://nextjs.org/docs/app/api-reference/config/next-config-js
import type { NextConfig } from 'next'

const nextConfig: NextConfig = {
  // No special config needed for Phase 1
}

export default nextConfig
```

### Root Layout

```typescript
// app/layout.tsx — required Root Layout
// Source: https://nextjs.org/docs/app/api-reference/file-conventions/layout#root-layout
import type { Metadata } from 'next'
import './globals.css'

export const metadata: Metadata = {
  title: 'What Lunch?',
  description: 'Random lunch picker for Taipei restaurants',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="zh-TW">
      <body>{children}</body>
    </html>
  )
}
```

### Complete lib/types.ts

```typescript
// lib/types.ts — single source of truth for all types and cuisine constants
// Pattern: as const satisfies Record<> for union type derivation

export const CUISINE_META = {
  chi:  { label: '中式', color: '#67C23A' },
  jp:   { label: '日式', color: '#E6A23C' },
  kr:   { label: '韓式', color: '#F56C6C' },
  tai:  { label: '泰式', color: '#909399' },
  west: { label: '西式', color: '#109399' },
} as const satisfies Record<string, { label: string; color: string }>

export type CuisineType = keyof typeof CUISINE_META
// Inferred: 'chi' | 'jp' | 'kr' | 'tai' | 'west'

export interface Restaurant {
  id: string
  name: string
  type: CuisineType
  price: number     // TWD, integer
  distance: number  // meters, integer
}
```

### shadcn/ui components.json (expected output)

```json
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "css": "app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  }
}
```

---

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Next.js 15 as "latest" | Next.js 16.1.6 is current latest | Oct 2025 | Phase requirement says "15" but npm installs 16 — needs clarification |
| `tailwind.config.js` | CSS `@theme` in globals.css | Tailwind v4 (Jan 2025) | No config file in v4; shadcn CLI handles it |
| `@radix-ui/react-*` packages | `radix-ui` unified package | shadcn 2025 update | shadcn new-york style uses single `radix-ui` dep |
| `default` style in shadcn | `new-york` style | 2024-2025 | `default` is deprecated; always choose `new-york` |
| `middleware.ts` | `proxy.ts` | Next.js 16 | Renamed; `middleware.ts` still works but deprecated |
| Sync `params`/`searchParams` | Must `await params` | Next.js 15+ (enforced in 16) | Breaking change — irrelevant to Phase 1 but critical for later phases |
| `next build` runs linter | Linter runs separately | Next.js 16 | `npm run lint` is now separate from `npm run build` |

**Deprecated/outdated:**
- `tailwind.config.js`: Replaced by CSS `@theme` in Tailwind v4
- shadcn `default` style: Use `new-york` instead
- Direct JSON imports for typed data: Use TypeScript `satisfies` pattern instead
- Duplicated type constants (Vue 2 pattern): Replaced by single `CUISINE_META` record

---

## Open Questions

### 1. Next.js 15 vs 16

- **What we know:** The phase requirement specifies "Next.js 15 App Router". The current `npm info next version` returns `16.1.6`. The `next@15` tag resolves to `15.5.12`.
- **What's unclear:** Whether the user wants to pin to Next.js 15 explicitly, or whether "Next.js 15" was written before Next.js 16 was released (Oct 2025) and latest is acceptable.
- **Recommendation:** Use `npx create-next-app@latest` which installs Next.js 16 unless the user explicitly wants to pin 15. If pinning is required: `npx create-next-app@next@15 what-lunch` or `npm install next@15`. The App Router architecture is identical between 15 and 16 for Phase 1 purposes — the breaking async params change only matters in later phases with dynamic routes. Flag this to the planner: the task should include a decision point.

### 2. Tailwind CSS v3 vs v4

- **What we know:** `create-next-app@latest` installs Tailwind v4 by default (confirmed via npm: `tailwindcss@4.1.18`). shadcn/ui CLI supports both v3 and v4.
- **What's unclear:** The requirements say "Tailwind CSS" without specifying a version. v4 is now standard.
- **Recommendation:** Use Tailwind v4 (the default). shadcn CLI detects the version automatically. No `tailwind.config.js` needed.

### 3. Colors in `CUISINE_META`

- **What we know:** The old Vue 2 `main.js` defines exact hex colors: `chi: '#67C23A'`, `jp: '#E6A23C'`, etc. These came from Element UI's color palette.
- **What's unclear:** Whether the new design should preserve these exact colors or use a new palette. The requirement says "fresh start" UI.
- **Recommendation:** Preserve the semantic colors from the old app for now (they encode cuisine-type associations users understand), but make them easy to change by keeping them in `CUISINE_META`. The planner should note this as a design decision for later phases.

---

## Sources

### Primary (HIGH confidence)

- Next.js official docs v16.1.6 — https://nextjs.org/docs/app/getting-started/installation (fetched 2026-02-18)
- Next.js official docs — https://nextjs.org/docs/app/getting-started/project-structure (fetched 2026-02-18)
- Next.js official docs — https://nextjs.org/docs/app/api-reference/config/typescript (fetched 2026-02-18)
- Next.js 16 release blog — https://nextjs.org/blog/next-16 (fetched 2026-02-18)
- shadcn/ui official docs — https://ui.shadcn.com/docs/installation/next (fetched 2026-02-18)
- shadcn/ui components.json schema — https://ui.shadcn.com/docs/components-json (fetched 2026-02-18)
- shadcn/ui Tailwind v4 guide — https://ui.shadcn.com/docs/tailwind-v4 (fetched 2026-02-18)
- Tailwind CSS v4 release — https://tailwindcss.com/blog/tailwindcss-v4 (fetched 2026-02-18)
- `npm info next version` — 16.1.6 (verified 2026-02-18)
- `npm info tailwindcss version` — 4.1.18 (verified 2026-02-18)
- `npm info react version` — 19.2.4 (verified 2026-02-18)
- `npm info shadcn version` — 3.8.5 (verified 2026-02-18)

### Secondary (MEDIUM confidence)

- TypeScript `as const satisfies` pattern — https://chrisvaillancourt.io/posts/combining-typescript-satisfies-and-const-assertion/ (pattern cross-referenced with TypeScript handbook)
- Vercel common App Router mistakes — https://vercel.com/blog/common-mistakes-with-the-next-js-app-router-and-how-to-fix-them (verified against official Next.js docs)
- WebSearch on Next.js 16 breaking changes — async params confirmed by official Next.js upgrade guide

### Tertiary (LOW confidence)

- WebSearch result: shadcn/ui radix-ui unified package migration (mentioned in search results, not directly fetched from docs)

---

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — all versions verified via npm registry and official docs
- Architecture: HIGH — lib/types.ts pattern is pure TypeScript with no external deps; verified against TypeScript handbook behavior
- Pitfalls: HIGH for Next.js 16 async params (official docs), HIGH for strict mode (official docs), MEDIUM for Tailwind v4 no-config-file (release blog verified)
- shadcn/ui: HIGH for style=new-york deprecation of default (official components.json docs)

**Research date:** 2026-02-18
**Valid until:** 2026-03-18 (30 days — Next.js and shadcn release frequently but App Router fundamentals are stable)

**Critical note for planner:** The phase requirement specifies "Next.js 15" but the current `npm install next@latest` produces Next.js 16. The planner should include a task decision point: pin to `next@15` or use `next@latest`. For Phase 1's purposes (scaffold + types + data), there is no behavioral difference. The difference matters in Phase 2+ when dynamic routes use `params`.
